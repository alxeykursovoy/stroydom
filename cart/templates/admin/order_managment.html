{% extends 'admin/base_site.html' %}

{% block content %}
<div class="container-fluid">
    <h1> Управление заказами</h1>
    
    <!-- Фильтры по статусу -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>Фильтр по статусу:</h5>
            <div class="btn-group" role="group">
                <a href="?status=all" class="btn btn-outline-primary {% if status_filter == 'all' %}active{% endif %}">
                    Все ({{ status_counts.all }})
                </a>
                <a href="?status=new" class="btn btn-outline-success {% if status_filter == 'new' %}active{% endif %}">
                    Новые ({{ status_counts.new }})
                </a>
                <a href="?status=processing" class="btn btn-outline-warning {% if status_filter == 'processing' %}active{% endif %}">
                    В обработке ({{ status_counts.processing }})
                </a>
                <a href="?status=shipped" class="btn btn-outline-info {% if status_filter == 'shipped' %}active{% endif %}">
                    Отправлены ({{ status_counts.shipped }})
                </a>
                <a href="?status=delivered" class="btn btn-outline-success {% if status_filter == 'delivered' %}active{% endif %}">
                    Доставлены ({{ status_counts.delivered }})
                </a>
                <a href="?status=cancelled" class="btn btn-outline-danger {% if status_filter == 'cancelled' %}active{% endif %}">
                    Отменены ({{ status_counts.cancelled }})
                </a>
            </div>
        </div>
    </div>
    
    <!-- Список заказов -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Дата</th>
                            <th>Пользователь</th>
                            <th>Товары</th>
                            <th>Сумма</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td><strong>#{{ order.id }}</strong></td>
                            <td>{{ order.created|date:"d.m.Y H:i" }}</td>
                            <td>
                                {{ order.user.first_name }} {{ order.user.last_name }}<br>
                                <small>{{ order.user.email }}</small>
                            </td>
                            <td>
                                {% for item in order.items.all %}
                                {{ item.product.name }} (×{{ item.quantity }})<br>
                                {% endfor %}
                            </td>
                            <td>{{ order.total_price }} ₽</td>
                            <td>
                                <span class="badge 
                                    {% if order.status == 'new' %}bg-success
                                    {% elif order.status == 'processing' %}bg-warning
                                    {% elif order.status == 'shipped' %}bg-info
                                    {% elif order.status == 'delivered' %}bg-primary
                                    {% else %}bg-danger{% endif %}">
                                    {{ order.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                            data-bs-toggle="dropdown">
                                        Изменить статус
                                    </button>
                                    <div class="dropdown-menu">
                                        <form method="post" action="{% url 'update_order_status' order.id %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="processing">
                                            <button type="submit" class="dropdown-item"> Подтвердить</button>
                                        </form>
                                        <form method="post" action="{% url 'update_order_status' order.id %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="shipped">
                                            <button type="submit" class="dropdown-item"> Отправить</button>
                                        </form>
                                        <form method="post" action="{% url 'update_order_status' order.id %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="delivered">
                                            <button type="submit" class="dropdown-item"> Доставлен</button>
                                        </form>
                                        <div class="dropdown-divider"></div>
                                        <form method="post" action="{% url 'update_order_status' order.id %}" 
                                              class="px-3 py-2">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="cancelled">
                                            <div class="mb-2">
                                                <label class="form-label small">Причина отказа:</label>
                                                <textarea name="cancel_reason" class="form-control form-control-sm" 
                                                          rows="2" required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-danger btn-sm w-100"> Отменить</button>
                                        </form>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <h5>Заказы не найдены</h5>
                                <p class="text-muted">Измените параметры фильтрации</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}